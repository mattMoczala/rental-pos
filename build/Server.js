"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Server=void 0;var express=require("express"),https=require("https"),fs=require("fs"),logger=require("morgan"),cookieParser=require("cookie-parser"),createError=require("http-errors"),path=require("path"),session=require("express-session"),logger_1=require("./logger"),passport=require("passport"),bodyParser=require("body-parser"),ConnectionConstructor_1=require("./db/ConnectionConstructor"),index=require("./routes/index"),rent=require("./routes/rent"),client=require("./routes/client"),item=require("./routes/item"),Server=function(){function e(e,s,t){this.app=express(),this.port=process.env.PORT||443,this.dbHostname=e,this.dbAuth=s,this.dbAuth.useNewUrlParser=!0,this.servableDomainList=t,this.dbConnection=new ConnectionConstructor_1.default(this.dbAuth,this.dbHostname)}return e.prototype._setUpExpressConfig=function(){var r=this;this.app.use(function(e,s,t){r.servableDomainList.includes(e.headers.host)?t():((0,logger_1.logAction)("".concat(e.method," ").concat(e.headers.host).concat(e.originalUrl," user requested unserved domain"),"error"),s.send('<div style="margin-left:auto;margin-right:auto"><b>404</b></div>'))}),this.app.use(bodyParser.json({limit:"50mb"})),this.app.use(bodyParser.urlencoded({limit:"50mb",extended:!0})),this.app.use(logger("dev")),this.app.use(express.json()),this.app.use(express.urlencoded({extended:!1})),this.app.use(cookieParser()),this.app.use(express.static(path.join(__dirname,"static"))),this.app.use(session({secret:"sessionSecret",cookie:{maxAge:54e6},saveUninitialized:!0,resave:!0})),this.app.use(express.json()),this.app.use(passport.initialize()),this.app.use(passport.session()),this.app.use(require("connect-flash")()),this.app.use("/",index.router),this.app.use("/client",client.router),this.app.use("/rent",rent.router),this.app.use("/item",item.router),this.app.use("/robots.txt",function(e,s,t){s.type("text/plain"),s.send("User-agent: *\nDisallow: /img")}),this.app.use(function(e,s,t){t(createError(404))}),this.app.use(function(e,s,t,r){t.locals.message=e.message,t.locals.error=e,t.status(e.status||500),t.send('<div style="margin-left:auto;margin-right:auto;width:40px"><b>'.concat(e.status||500,"</b></div>"))})},e.prototype.startWebServer=function(){var e=this;this._setUpExpressConfig(),this.server=https.createServer({cert:fs.readFileSync(__dirname+"/keys/https/certificate.pem"),key:fs.readFileSync(__dirname+"/keys/https/key.pem")},this.app),this.server.listen(this.port,function(){(0,logger_1.logAction)("server started on ".concat(e.servableDomainList,":").concat(e.port,"..."),"info")})},e}();exports.Server=Server;